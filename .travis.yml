language: ruby
env:
  global:
    - APP_BUNDLE_SRC=./vendor/src
    - APP_INSTALL_API_DIR=$TRAVIS_BUILD_DIR/api
    - APP_INSTALL_CLIENT_DIR=$TRAVIS_BUILD_DIR/client
    - APP_SRC_DIR=$TRAVIS_BUILD_DIR/src
    - APP_LOCAL_DIR=$TRAVIS_BUILD_DIR/local
rvm:
- 2.3.1
branches:
  only:
    - development
before_install:
  - gem install bundler
  - curl https://raw.githubusercontent.com/creationix/nvm/v0.32.1/install.sh | bash
  - nvm install 6.9.1
  - nvm use 6.9.1
  - npm install -g ember-cli@2.9.1
  - npm install -g bower@1.8.0
  - cd $APP_LOCAL_DIR
install:
  - echo Installing API to $APP_INSTALL_API_DIR
  - "./install.sh --package opentbl/api --install $APP_INSTALL_API_DIR --platform thinkspace"
  - mkdir -p $APP_INSTALL_API_DIR/vendor/src/thinkspace/api
  - mkdir -p $APP_INSTALL_API_DIR/vendor/src/totem/api
  - mkdir -p $APP_INSTALL_API_DIR/.git
  - cp -a $APP_SRC_DIR/thinkspace/api/. $APP_INSTALL_API_DIR/vendor/src/thinkspace/api/
  - cp -a $APP_SRC_DIR/totem/api/. $APP_INSTALL_API_DIR/vendor/src/totem/api/
  - cd $APP_INSTALL_API_DIR
  - echo Bundling with $APP_BUNDLE_SRC
  - bundle install
  - echo Installing CLIENT to $APP_INSTALL_CLIENT_DIR
  - cd $APP_LOCAL_DIR
  - "./install.sh --package opentbl/client --install $APP_INSTALL_CLIENT_DIR --platform thinkspace"
  - cd $APP_INSTALL_CLIENT_DIR
  - ember deploy staging --activate
script:
  - echo Skipping script step...
before_deploy:
  - cd $APP_INSTALL_API_DIR
  - git init
  - git remote add heroku git@heroku.com:opentbl-staging.git
deploy:
  provider: heroku
  skip_cleanup: true
  on: development
  api_key:
    secure: WzdSbQK3wlshtResAndOIz4BI9w/BurFY6GHm8WvOuMf5uNCXxrUwYm1qycMEmlZQGXufUxh4hBbO24ZjcJkdjYNn/cK/Uh3IqmLXc0Xa/ITLoBdbQflxn/6tF6PkwYNHkq9/KHPDWQse3r0hzngbB8fYxCjBIwSbezEZxI8MXQ7AWuEIJxoctIPhapq+8c4XQBdGQfrDmXTHtPRVmMWdY/rhcQd+XwR4oPZgiuTWOz6l3xJwGcHZgau+xIDm/KXoljnuLEHpOowr62Nfz4PeSYstlJ4+atca+kke67bFAH6wE0uDaqivXFrsuv46CVlQxjZgcuS10dO0/PMBRPdIb2cQz9a6dFDpTYiIR/GCOxeJfm8sSOsObUnSuLe9381DQofcOQj+AQvew90sXnupul2WojIra55+WsMunP/5X9Ef2ENscZOBKsWabcOvdB79atd7LSmpUnSHhj0kmnx4/lXgc5esNbEmHF+Ynb7i+WwXnQVTvzir+tzV6/6g/mSwNX01ctAlhg3cbNYO6N8j+vLj6vWVnp1BIdO1fkaiI5hvzC3hkPseVgDM1sAUCp1tcf2lDpIj81QQM6AuP1dq1t0Dv6iia5Ivm0Atyt8RhfkdJTf889fej32Tv1cdVLKJtK3N5noNIQX3/rjYjBtqLpPVkU/7QJ2ZXkEeTtAqQE=
  app: opentbl-staging
  run:
    - rails totem:db:production_migrate
    - rails totem:db:domain:load
